jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: danielga/garrysmod_common
          ref: master
          path: garrysmod_common
          submodules: recursive

      - name: Install deps
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get -y --no-install-recommends install build-essential cmake gdb git wget make g++ g++-multilib gcc-multilib libc6-dev-i386

      - name: Build premake from source (beta7)
        run: |
          wget https://github.com/premake/premake-core/archive/refs/tags/v5.0.0-beta7.tar.gz -O premake-src.tar.gz
          tar -xzf premake-src.tar.gz
          cd premake-core-5.0.0-beta7
          make -f Bootstrap.mak linux
          sudo install -m 0755 bin/release/premake5 /usr/local/bin/premake5
          premake5 --version

      - name: Generate Project
        run: premake5 --gmcommon=garrysmod_common gmake

      - name: Make
        run: |
          cd projects/linux/gmake
          make -j"$(nproc)"
          make config=release_x86 -j"$(nproc)"
          ls

      - name: Upload Linux Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_build_artifacts
          path: |
            projects/linux/gmake/**/x86/**
            projects/linux/gmake/**/x86_64/**
